<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MapCrown ‚Ä¢ Geo Explorer</title>

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <!-- Brevo form styles -->
  <link rel="stylesheet" href="https://sibforms.com/forms/end-form/build/sib-styles.css">

  <style>
    :root{
      --bg:#061225; --bg2:#071a33;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --text:#eaf1ff; --muted:rgba(234,241,255,.72);
      --brand:#2be2ff; --brand2:#7aa7ff;
      --shadow:0 18px 55px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(43,226,255,.10), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(122,167,255,.12), transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color:var(--text);
      overflow-x:hidden;
    }

    /* Header */
    .topbar{
      position:sticky; top:0; z-index:1000;
      background:rgba(6,18,37,.62);
      backdrop-filter: blur(14px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:12px 14px;
    }
    .topbarInner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
      min-width:max-content;
    }
    .logoDot{
      width:34px;height:34px;border-radius:12px;
      background: linear-gradient(135deg, rgba(122,167,255,.95), rgba(43,226,255,.85));
      border:1px solid rgba(255,255,255,.16);
      display:grid; place-items:center;
      box-shadow: 0 10px 30px rgba(43,226,255,.20);
    }
    .brandText small{display:block; font-size:12px; font-weight:700; color:var(--muted); margin-top:2px;}

    .controls{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    select, .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      outline:none;
      font-weight:800;
      cursor:pointer;
    }
    select option{color:#0b1220}

    /* Desktop nav */
    .navDesktop{display:flex; gap:8px; align-items:center;}
    .navLink{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
    }

    /* Mobile menu (subscribe ONLY here) */
    .menuBtn{display:none;}
    .menu{
      position:absolute;
      right:14px;
      top:64px;
      width:min(280px, 86vw);
      background:rgba(7,20,39,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .menuItem{
      width:100%;
      text-align:left;
      padding:12px 14px;
      border:0;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .menuItem:last-child{border-bottom:0}
    .menuItem:hover{background:rgba(255,255,255,.07)}
    .hidden{display:none !important;}

    /* Layout */
    .wrap{
      max-width:1200px;
      margin:14px auto 18px;
      padding:0 14px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      align-items:stretch;
    }
    .stage, .panel{
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      background: rgba(255,255,255,.05);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    #map{
      height: calc(100vh - 150px);
      min-height:520px;
      width:100%;
      background:#0b1220;
    }

    .panel{display:flex; flex-direction:column;}
    .panelHead{padding:14px; border-bottom:1px solid rgba(255,255,255,.08);}
    .panelHead h2{margin:0 0 6px; font-size:18px}
    .panelHead p{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}
    .panelBody{padding:12px 14px 14px; overflow:auto;}
    .card{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:12px;
      margin-bottom:12px;
    }
    .krow{display:flex; justify-content:space-between; gap:10px; padding:7px 0; border-bottom:1px dashed rgba(255,255,255,.10);}
    .krow:last-child{border-bottom:0}
    .k{color:var(--muted); font-weight:800}
    .v{font-weight:900}
    .details{color:rgba(234,241,255,.92); font-size:14px; line-height:1.55;}
    .mini{font-size:12px; color:rgba(234,241,255,.60); line-height:1.5;}

    /* Modals */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.58);
      backdrop-filter: blur(10px);
      display:grid; place-items:center;
      z-index:10000;
      padding:14px;
    }
    .modalCard{
      width:min(760px, 96vw);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(7,20,39,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid rgba(255,255,255,.08);}
    .modalHead h3{margin:0; font-size:17px}
    .modalBody{padding:14px}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .cta{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
    }
    .cta.primary{
      border-color: rgba(43,226,255,.35);
      background: linear-gradient(135deg, rgba(43,226,255,.18), rgba(122,167,255,.12));
    }

    /* Tutorial overlay */
    .tourOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      z-index:11000;
      display:none;
    }
    .tourBox{
      position:fixed;
      z-index:11001;
      width:min(420px, 92vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(7,20,39,.95);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .tourTitle{font-weight:1000; margin:0 0 6px;}
    .tourDesc{margin:0; color:rgba(234,241,255,.78); font-size:13px; line-height:1.55;}
    .tourBtns{display:flex; gap:10px; justify-content:flex-end; margin-top:12px;}
    .tourBtns button{padding:10px 12px; border-radius:12px; font-weight:900; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--text); cursor:pointer;}
    .tourBtns button.primary{border-color: rgba(43,226,255,.35); background: linear-gradient(135deg, rgba(43,226,255,.18), rgba(122,167,255,.12));}
    .hl{
      position:relative;
      outline: 3px solid rgba(43,226,255,.85);
      outline-offset: 6px;
      border-radius: 14px;
      z-index:11002;
    }

    /* Footer */
    .footer{
      max-width:1200px; margin:10px auto 26px; padding:0 14px;
      color:var(--muted); font-size:13px;
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;
    }

    /* Mobile */
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr; gap:12px;}
      #map{height: calc(100vh - 210px); min-height:460px;}
      .navDesktop{display:none;}
      .menuBtn{display:inline-flex;}
      .controls select{max-width:155px;}
    }
    @media (max-width: 480px){
      .brandText{display:none;}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand">
        <div class="logoDot">üëë</div>
        <div class="brandText">
          MapCrown
          <small>Satellite ‚Ä¢ Quiz ‚Ä¢ Geo Learning</small>
        </div>
      </div>

      <nav class="navDesktop" aria-label="Primary">
        <button class="navLink" type="button" id="btnAbout">About Founder</button>
        <button class="navLink" type="button" id="btnContact">Contact</button>
        <button class="navLink" type="button" id="btnHelp">Help</button>
      </nav>

      <div class="controls">
        <select id="category" title="Category">
          <option value="countries">Countries</option>
          <option value="states">States</option>
          <option value="cities">Cities</option>
          <option value="rivers">Rivers</option>
          <option value="mountains">Mountains</option>
        </select>

        <select id="examMode" title="Exam Mode">
          <option value="general">General</option>
          <option value="upsc">UPSC</option>
          <option value="nda">NDA</option>
          <option value="cds">CDS</option>
          <option value="ssc">SSC</option>
        </select>

        <button id="menuBtn" class="btn menuBtn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="mobileMenu">
          ‚ò∞ Menu
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="menu hidden" role="menu" aria-label="Mobile menu">
      <button class="menuItem" type="button" id="mAbout">üë§ About Founder</button>
      <button class="menuItem" type="button" id="mContact">‚úâÔ∏è Contact</button>
      <button class="menuItem" type="button" id="mHelp">‚ùì Help</button>
      <button class="menuItem" type="button" id="mSubscribe">üì© Subscribe</button>
    </div>
  </header>

  <main class="wrap">
    <section class="stage">
      <div id="map"></div>
    </section>

    <aside class="panel">
      <div class="panelHead">
        <h2 id="title">Select something</h2>
        <p>Choose category ‚Üí click on map feature ‚Üí see details here.</p>
      </div>
      <div class="panelBody">
        <div class="card">
          <div class="krow"><span class="k">Name</span><span id="cName" class="v">‚Äî</span></div>
          <div class="krow"><span class="k">Type</span><span id="cType" class="v">‚Äî</span></div>
          <div class="krow"><span class="k">Exam</span><span id="modeText" class="v">GENERAL</span></div>
        </div>
        <div class="card">
          <div id="details" class="details">Loading data‚Ä¶ If you see ‚ÄúMissing file‚Äù, fix your /data filenames.</div>
          <div id="debug" class="mini" style="margin-top:10px;"></div>
        </div>
        <div class="card">
          <div class="details"><b>Tip:</b> Cities are shown as clean dots (no messy icons). Click a dot to zoom.</div>
        </div>
      </div>
    </aside>
  </main>

  <footer class="footer">
    <div><b style="color:var(--text)">MapCrown</b> ‚Ä¢ Geography learning platform</div>
    <div>Created by <b style="color:var(--text)">Himanshu Kumar</b> ‚Ä¢ ¬© <span id="yr"></span></div>
  </footer>

  <!-- Subscribe Modal -->
  <div id="subModal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <h3>üì© Subscribe to MapCrown</h3>
        <button class="btn" type="button" id="closeSub">Close</button>
      </div>
      <div class="modalBody">
        <div class="details">Get updates + learning tips. Confirm subscription via email (double opt-in).</div>

        <div style="height:12px;"></div>

        <!-- Minimal working Brevo form (your action extracted) -->
        <div style="border:1px solid rgba(255,255,255,.10); border-radius:18px; padding:12px; background:rgba(255,255,255,.03);">
          <form method="POST"
            action="https://db151eb5.sibforms.com/serve/MUIFADqAs_XXKqNfYAF7xFrF9YRCZD_vkNiqLSQflLgICazHcrDQsHyRVzLTzcMffVXJ0fBw2lMh7dmIkD5iMUxzMGr_35NLQkWCPyLXaBreyPR2sTS-Xu97alcBDyeOeSBiCI0sUqeNUUtz9OumNhfmYAgzPQPgy9-Q-CsXqN-W9zTKoLP0vt2dCOqiwHAEfKXPK8ySZOjy71grgw=="
            data-type="subscription">

            <label style="display:block; font-weight:900; margin:6px 0 8px;">Email address</label>
            <input class="input" type="email" name="EMAIL" autocomplete="email" placeholder="you@example.com" required
              style="width:100%; padding:14px; border-radius:14px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--text); font-weight:900; outline:none;" />

            <input type="text" name="email_address_check" value="" class="input--hidden" style="display:none;">
            <input type="hidden" name="locale" value="en">

            <button type="submit"
              style="margin-top:10px; width:100%; padding:12px 14px; border-radius:14px; cursor:pointer; font-weight:1000;
                     border:1px solid rgba(43,226,255,.35);
                     background:linear-gradient(135deg, rgba(43,226,255,.18), rgba(122,167,255,.12));
                     color:var(--text);">
              Join Now üöÄ
            </button>
          </form>
        </div>

        <div class="mini" style="margin-top:10px;">
          If email doesn‚Äôt arrive: check Spam/Promotions and mark ‚ÄúNot spam‚Äù.
        </div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <h3>üë§ About Founder</h3>
        <button class="btn" type="button" id="closeAbout">Close</button>
      </div>
      <div class="modalBody">
        <div class="details">
          <b>Himanshu Kumar</b> (Muzaffarpur) built <b>MapCrown</b> to help students prepare geography for
          <b>UPSC, NDA, CDS, SSC</b> with an interactive map-first learning style.
          <br><br>
          The goal is simple: <b>faster revision + better memory</b> using categories like Countries, States, Cities, Rivers and Mountains.
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Modal -->
  <div id="contactModal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <h3>‚úâÔ∏è Contact</h3>
        <button class="btn" type="button" id="closeContact">Close</button>
      </div>
      <div class="modalBody">
        <div class="details">
          For support, feedback, or suggestions, email us:
        </div>
        <div class="btnRow">
          <a class="cta primary" href="mailto:support@mapcrown.online?subject=MapCrown%20Support">üìß Email Support</a>
          <a class="cta" href="mailto:mapcrown.online@zohomail.in?subject=MapCrown%20Feedback">üí¨ Send Feedback</a>
        </div>
        <div class="mini" style="margin-top:10px;">
          (If your support email is different, change the mailto links in this modal.)
        </div>
      </div>
    </div>
  </div>

  <!-- Tutorial overlay -->
  <div id="tourOverlay" class="tourOverlay"></div>
  <div id="tourBox" class="tourBox hidden">
    <h4 class="tourTitle" id="tourTitle">Welcome</h4>
    <p class="tourDesc" id="tourDesc">‚Äî</p>
    <div class="tourBtns">
      <button id="tourSkip">Skip</button>
      <button class="primary" id="tourNext">Next</button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Brevo core script -->
  <script defer src="https://sibforms.com/forms/end-form/build/main.js"></script>

  <script>
    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    $("yr").textContent = new Date().getFullYear();

    function setDetails({name="‚Äî", type="‚Äî", html="‚Äî"}){
      $("title").textContent = name;
      $("cName").textContent = name;
      $("cType").textContent = type;
      $("details").innerHTML = html;
    }
    function dbg(msg){ $("debug").textContent = msg || ""; }

    // ===== Map init (Satellite + labels) =====
    const map = L.map("map", { zoomControl:true }).setView([20.5937, 78.9629], 4);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, attribution: "Tiles ¬© Esri" }
    ).addTo(map);

    // label overlay
    L.tileLayer(
      "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19 }
    ).addTo(map);

    // ===== Exam mode text =====
    $("examMode").addEventListener("change", () => {
      $("modeText").textContent = ($("examMode").value || "general").toUpperCase();
    });

    // ===== Mobile menu (professional) =====
    const menuBtn = $("menuBtn");
    const mobileMenu = $("mobileMenu");
    function openMenu(){ mobileMenu.classList.remove("hidden"); menuBtn.setAttribute("aria-expanded","true"); }
    function closeMenu(){ mobileMenu.classList.add("hidden"); menuBtn.setAttribute("aria-expanded","false"); }
    function toggleMenu(){ mobileMenu.classList.contains("hidden") ? openMenu() : closeMenu(); }
    menuBtn.addEventListener("click", (e)=>{ e.stopPropagation(); toggleMenu(); });
    document.addEventListener("click", (e)=>{
      if (mobileMenu.classList.contains("hidden")) return;
      const inside = mobileMenu.contains(e.target) || menuBtn.contains(e.target);
      if (!inside) closeMenu();
    });

    // ===== Modals open/close =====
    function openModal(el){ el.classList.remove("hidden"); el.setAttribute("aria-hidden","false"); }
    function closeModal(el){ el.classList.add("hidden"); el.setAttribute("aria-hidden","true"); }

    const subModal = $("subModal");
    const aboutModal = $("aboutModal");
    const contactModal = $("contactModal");

    function openSubscribe(){ openModal(subModal); closeMenu(); }
    function closeSubscribe(){ closeModal(subModal); }

    $("closeSub").addEventListener("click", closeSubscribe);
    subModal.addEventListener("click", (e)=>{ if(e.target===subModal) closeSubscribe(); });

    function openAbout(){ openModal(aboutModal); closeMenu(); }
    function closeAbout(){ closeModal(aboutModal); }
    $("closeAbout").addEventListener("click", closeAbout);
    aboutModal.addEventListener("click", (e)=>{ if(e.target===aboutModal) closeAbout(); });

    function openContact(){ openModal(contactModal); closeMenu(); }
    function closeContact(){ closeModal(contactModal); }
    $("closeContact").addEventListener("click", closeContact);
    contactModal.addEventListener("click", (e)=>{ if(e.target===contactModal) closeContact(); });

    $("btnAbout").addEventListener("click", openAbout);
    $("btnContact").addEventListener("click", openContact);
    $("btnHelp").addEventListener("click", ()=> startTour(true));

    $("mAbout").addEventListener("click", openAbout);
    $("mContact").addEventListener("click", openContact);
    $("mHelp").addEventListener("click", ()=> startTour(true));
    $("mSubscribe").addEventListener("click", openSubscribe);

    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){ closeMenu(); closeSubscribe(); closeAbout(); closeContact(); stopTour(); }
    });

    // ===== Auto subscribe popup after 10s (first time only) =====
    (function autoPopup(){
      const KEY="mapcrown_sub_popup_seen_v2";
      if(localStorage.getItem(KEY)==="1") return;
      setTimeout(()=>{ openSubscribe(); localStorage.setItem(KEY,"1"); }, 10000);
    })();

    // ===== Data loading + selectable layers =====
    const DATA = {
      countries: ["/data/countries.min.json", "/data/countries.min", "/data/countries.json", "/data/countries.geojson"],
      states:    ["/data/states_provinces.min.json", "/data/states_provinces.min", "/data/states.json", "/data/states.geojson"],
      cities:    ["/data/cities_major.min.json", "/data/cities_major.min", "/data/cities.json"],
      rivers:    ["/data/rivers.min.json", "/data/rivers.min", "/data/rivers.json", "/data/rivers.geojson"],
      mountains: ["/data/mountains_peaks.min.json", "/data/mountains_peaks.min", "/data/mountains.json", "/data/mountains.geojson"]
    };

    async function fetchFirstOk(urls){
      for(const u of urls){
        try{
          const r = await fetch(u, { cache:"no-store" });
          if(!r.ok) continue;
          return { url:u, json: await r.json() };
        }catch(e){ /* try next */ }
      }
      return null;
    }

    let selectedLayer = null;
    function resetSelected(){
      if(!selectedLayer) return;
      if(selectedLayer.__resetStyle) selectedLayer.__resetStyle();
      selectedLayer = null;
    }

    function styleFor(type){
      if(type==="polygon") return { weight:1, color:"#6aa9ff", fillColor:"#2be2ff", fillOpacity:0.10 };
      if(type==="line")    return { weight:2, color:"#2be2ff", opacity:0.85 };
      return {};
    }

    // Layer holders
    const layers = {
      countries: null,
      states: null,
      rivers: null,
      mountains: null,
      cities: null
    };

    // Create selectable GeoJSON
    function makeSelectableGeoJson(geo, kind){
      const isLine = (kind==="rivers");
      const layer = L.geoJSON(geo, {
        style: () => isLine ? styleFor("line") : styleFor("polygon"),
        onEachFeature: (feature, lyr) => {
          // store reset style
          const originalStyle = isLine ? styleFor("line") : styleFor("polygon");
          lyr.__resetStyle = () => lyr.setStyle(originalStyle);

          lyr.on("click", () => {
            resetSelected();
            selectedLayer = lyr;

            // highlight
            if(isLine){
              lyr.setStyle({ weight:4, color:"#7aa7ff", opacity:1 });
            }else{
              lyr.setStyle({ weight:3, color:"#2be2ff", fillOpacity:0.22 });
            }
            if(lyr.bringToFront) lyr.bringToFront();

            const p = feature.properties || {};
            const name =
              p.name || p.NAME || p.admin || p.ADMIN || p.Name || p.name_en || p.geonunit || p.sov_a3 || "Unknown";

            // Build a clean property list (avoid repeated junk)
            const important = [];
            function add(label, val){
              if(val===undefined || val===null) return;
              const s = String(val).trim();
              if(!s || s==="‚Äî" || s==="null" || s==="undefined") return;
              important.push(`<b>${label}:</b> ${escapeHtml(s)}`);
            }

            // Try best common fields
            if(kind==="countries"){
              add("Capital", p.capital || p.CAPITAL || p.capital_en);
              add("Region", p.region || p.REGION || p.continent);
              add("ISO", p.iso_a2 || p.ISO_A2 || p.iso2 || p.ISO2 || p.iso_a3 || p.ISO_A3);
              add("Population", p.pop_est || p.POP_EST || p.population);
            }
            if(kind==="states"){
              add("State/Province Code", p.iso_3166_2 || p.iso || p.postal);
              add("Admin", p.admin || p.ADMIN || p.country);
              add("Type", p.type || p.TYPE);
            }
            if(kind==="rivers"){
              add("River Class", p.featurecla || p.FEATURECLA || p.type);
              add("Alt name", p.name_alt || p.NAME_ALT);
              add("Note", p.note || p.NOTE);
              add("Scale rank", p.scalerank || p.SCALERANK);
            }
            if(kind==="mountains"){
              add("Elevation", p.elevation || p.ELEV || p.elev || p.height);
              add("Range", p.range || p.RANGE);
              add("Country", p.country || p.COUNTRY || p.admin || p.ADMIN);
            }

            setDetails({
              name,
              type: kind.slice(0,1).toUpperCase()+kind.slice(1,kind.length-1), // Countries->Countrie (not perfect)
              html: `
                <div><b>Name:</b> ${escapeHtml(name)}</div>
                <div style="margin-top:8px">${important.length ? important.join("<br>") : "<span style='color:rgba(234,241,255,.70)'>No extra details found in this file.</span>"}</div>
              `
            });
          });
        }
      });
      return layer;
    }

    // Cities layer (points) ‚Äî clean dots + cluster + zoom on click
    function makeCitiesLayer(geo){
      const cluster = L.markerClusterGroup({
        showCoverageOnHover:false,
        maxClusterRadius:50
      });

      const cityLayer = L.geoJSON(geo, {
        pointToLayer: (feature, latlng) => {
          return L.circleMarker(latlng, {
            radius:5,
            color:"#2be2ff",
            weight:2,
            fillColor:"#7aa7ff",
            fillOpacity:0.35
          });
        },
        onEachFeature: (feature, lyr) => {
          const p = feature.properties || {};
          const name = p.name || p.NAME || p.name_en || p.city || "Unknown City";
          const country = p.country || p.ADMIN || p.admin || p.iso_a2 || p.ISO_A2 || "‚Äî";
          const pop = p.pop_max || p.population || p.POP_MAX || "‚Äî";

          lyr.on("click", () => {
            resetSelected();
            selectedLayer = lyr;
            lyr.setStyle({ radius:8, weight:3, fillOpacity:0.55 });
            map.setView(lyr.getLatLng(), Math.max(map.getZoom(), 7), { animate:true });

            setDetails({
              name,
              type: "City",
              html: `
                <b>Country:</b> ${escapeHtml(String(country))}<br>
                <b>Population:</b> ${escapeHtml(String(pop))}<br>
                <span style="color:rgba(234,241,255,.70)">Tip: zoom in/out for better view.</span>
              `
            });
          });
        }
      });

      cluster.addLayer(cityLayer);
      return cluster;
    }

    // Switch layers by category
    let activeKey = "countries";
    function clearAll(){
      resetSelected();
      Object.values(layers).forEach(l => { if(l && map.hasLayer(l)) map.removeLayer(l); });
    }

    async function ensureLayer(key){
      if(layers[key]) return true;

      const res = await fetchFirstOk(DATA[key]);
      if(!res){
        setDetails({ name:"Missing file", type:"Setup", html:`Could not load <b>${key}</b> dataset. Check /data filenames.`});
        dbg(`Missing: ${DATA[key].join(" OR ")}`);
        return false;
      }

      dbg(`Loaded ${key} from: ${res.url}`);

      const geo = res.json;
      if(key==="cities"){
        layers.cities = makeCitiesLayer(geo);
      }else{
        layers[key] = makeSelectableGeoJson(geo, key);
      }
      return true;
    }

    async function showCategory(key){
      activeKey = key;
      clearAll();

      const ok = await ensureLayer(key);
      if(!ok) return;

      map.addLayer(layers[key]);

      setDetails({
        name: key.toUpperCase(),
        type: "Category",
        html: `Now click a feature on the map to select.<br><span style="color:rgba(234,241,255,.70)">If you still can‚Äôt select, your file may not be valid GeoJSON.</span>`
      });
    }

    $("category").addEventListener("change", () => showCategory($("category").value));

    // Start
    (async function boot(){
      try{
        await showCategory("countries");
      }catch(e){
        setDetails({ name:"Error", type:"Startup", html:"A script error happened. Check console." });
        console.error(e);
      }
    })();

    // ===== Tutorial (first time) =====
    const TOUR_KEY = "mapcrown_tour_seen_v1";
    const tourOverlay = $("tourOverlay");
    const tourBox = $("tourBox");
    const tourTitle = $("tourTitle");
    const tourDesc = $("tourDesc");
    const tourNext = $("tourNext");
    const tourSkip = $("tourSkip");

    const steps = [
      { el: $("category"), title:"Choose a Category", desc:"Select Countries / States / Cities / Rivers / Mountains. The map loads that topic." },
      { el: $("examMode"), title:"Pick Exam Mode", desc:"Switch focus for UPSC, NDA, CDS, SSC. (You can use it for your quiz logic too.)" },
      { el: $("map"), title:"Click on the Map", desc:"Tap/click a feature to SELECT it. It will highlight and show details on right." },
      { el: document.querySelector(".panel"), title:"Read Details", desc:"Details appear here. For cities, map will auto-zoom." },
      { el: $("menuBtn"), title:"Mobile Menu", desc:"On mobile, open Menu for About / Contact / Help / Subscribe." }
    ];

    let stepIndex = 0;

    function clearHighlights(){
      document.querySelectorAll(".hl").forEach(n => n.classList.remove("hl"));
    }

    function placeTourBoxNear(el){
      const r = el.getBoundingClientRect();
      const pad = 14;
      const top = Math.min(window.innerHeight - 240, Math.max(pad, r.bottom + 12));
      const left = Math.min(window.innerWidth - 440, Math.max(pad, r.left));
      tourBox.style.top = top + "px";
      tourBox.style.left = left + "px";
    }

    function renderStep(){
      clearHighlights();
      const s = steps[stepIndex];
      if(!s || !s.el) return;

      s.el.classList.add("hl");
      tourTitle.textContent = s.title;
      tourDesc.textContent = s.desc;
      placeTourBoxNear(s.el);

      tourNext.textContent = (stepIndex === steps.length - 1) ? "Finish" : "Next";
    }

    function startTour(force=false){
      if(!force && localStorage.getItem(TOUR_KEY)==="1") return;
      localStorage.setItem(TOUR_KEY, "1");
      stepIndex = 0;
      tourOverlay.style.display = "block";
      tourBox.classList.remove("hidden");
      renderStep();
      closeMenu();
    }

    function stopTour(){
      tourOverlay.style.display = "none";
      tourBox.classList.add("hidden");
      clearHighlights();
    }

    tourSkip.addEventListener("click", stopTour);
    tourOverlay.addEventListener("click", stopTour);
    tourNext.addEventListener("click", ()=>{
      if(stepIndex < steps.length - 1){
        stepIndex++;
        renderStep();
      }else{
        stopTour();
      }
    });

    // Auto tutorial on first visit
    setTimeout(()=> startTour(false), 1200);

    // ===== Utilities =====
    function escapeHtml(str){
      return str.replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
  </script>
</body>
</html>
